<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>遅延オープナー（連打対応）</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; padding: 28px; max-width: 820px; margin: auto; }
  textarea { width:100%; height:120px; font-size:14px; padding:8px; box-sizing:border-box; }
  input[type="number"] { width:100px; padding:6px; }
  button { padding:10px 16px; font-size:16px; margin-left:8px; cursor:pointer; }
  .row { display:flex; gap:8px; align-items:center; margin-top:12px; }
  #status { margin-top:14px; color:#333; }
  ul { padding-left: 18px; }
</style>
</head>
<body>
  <h2>遅延オープナー（連打対応 / GitHub Pages可）</h2>
  <p>使い方：上のテキストエリアに開きたいURLを1行ずつ入れる（または既存の順で使う）。<br>
  「開く」ボタンを連打すると、各クリックごとに指定秒数（秒）のカウント後にそのURLへ移動する新しいタブが開きます。元のページのフォーカスは奪われません。</p>

  <label>URLリスト（1行に1つ）</label>
  <textarea id="urlList" placeholder="https://example.com/1
https://example.com/2
https://example.com/3">https://open2ch.net/ajax/add_history.cgi?bbs=livejupiter&key=1761988917
https://open2ch.net/ajax/add_history.cgi?bbs=livejupiter&key=1701197940</textarea>

  <div class="row">
    <label for="delay">待ち時間（秒）</label>
    <input id="delay" type="number" min="0" step="0.1" value="3" />
    <button id="openBtn">開く（連打OK）</button>
    <button id="resetBtn">リセット（最初のURLに戻す）</button>
  </div>

  <div id="status"></div>

<script>
(() => {
  const urlTextarea = document.getElementById('urlList');
  const delayInput = document.getElementById('delay');
  const openBtn = document.getElementById('openBtn');
  const resetBtn = document.getElementById('resetBtn');
  const status = document.getElementById('status');

  let urls = parseUrls();
  let index = 0;

  function parseUrls() {
    return urlTextarea.value
      .split(/\r?\n/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  urlTextarea.addEventListener('input', () => {
    urls = parseUrls();
    if (index >= urls.length) index = urls.length - 1;
    updateStatus();
  });

  resetBtn.addEventListener('click', () => {
    urls = parseUrls();
    index = 0;
    updateStatus();
  });

  function updateStatus() {
    status.innerHTML = `<strong>次のURLインデックス:</strong> ${index} / ${urls.length}`;
  }

  // クリックごとに次のURLを使い、指定秒数待ってからそのURLへ移動する「データURL」を
  // 新タブに読み込ませる方式。noopenerでフォーカス奪取を防ぐ。
  openBtn.addEventListener('click', () => {
    urls = parseUrls();
    if (index >= urls.length) {
      status.textContent = 'URLがもうありません（リストを更新するかリセットしてください）';
      return;
    }

    const target = urls[index];
    const delay = Math.max(0, Number(delayInput.value) || 3);

    // 新タブで表示するHTML（カウントダウンを見せてから移動）
    const childHtml = `
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Opening...</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;}
  .box{text-align:center}
  .count{font-size:48px;margin:8px 0}
  .info{color:#444}
</style>
</head>
<body>
  <div class="box">
    <div class="info">このタブは ${delay} 秒後に目的のページへ移動します</div>
    <div class="count" id="cnt">${delay}</div>
    <div class="info" id="url">${escapeHtml(target)}</div>
  </div>
<script>
  (function(){
    var t = ${Math.ceil(delay)};
    var rem = ${delay};
    var cnt = document.getElementById('cnt');
    var int = setInterval(function(){
      rem -= 1;
      if(rem <= 0){ clearInterval(int); cnt.textContent = 0; setTimeout(function(){ location.replace(${JSON.stringify(target)}); }, 250); }
      else cnt.textContent = Math.ceil(rem);
    }, 1000);
    // fallback in case of fractional delays
    setTimeout(function(){ location.replace(${JSON.stringify(target)}); }, ${Math.round(delay * 1000)});
  })();
</script>
</body>
</html>
`.trim();

    // data: URL を生成（UTF-8, encodeURIComponent）
    const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(childHtml);

    // user gesture の範囲内で window.open() を呼ぶ -> ブロックされにくい
    const newWin = window.open(dataUrl, '_blank', 'noopener');

    if (!newWin) {
      alert('ポップアップがブロックされました。ブラウザのアドレスバー右の「ポップアップブロック」を解除してください');
      return;
    }

    // 進行管理
    index++;
    updateStatus();

    // 表示のため簡単なスケジュール表示を追加
    const li = document.createElement('div');
    li.textContent = `予約済み: ${target} （${delay}秒後にタブで移動）`;
    status.appendChild(document.createElement('br'));
    status.appendChild(li);
  });

  // HTML内で表示するURLを簡易エスケープ
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g,function(m){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];});
  }

  // 初期ステータス
  updateStatus();
})();
</script>
</body>
</html>
